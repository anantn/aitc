# HG changeset patch
# Parent f6a5b82eb76bd7c0d4f01cf3bf87cd4f533c2134
# User Anant Narayanan <anant@kix.in>
try: -b do -p all -u all -t all

diff --git a/services/common/rest.js b/services/common/rest.js
--- a/services/common/rest.js
+++ b/services/common/rest.js
@@ -148,6 +148,14 @@
   timeout: null,
 
   /**
+   * The encoding with which the response to this request must be treated.
+   * If a charset parameter is available in the HTTP Content-Type header for
+   * this response, that will always be used, and this value is ignored. If
+   * this value is not set (i.e. set to null), we default to UTF-8.
+   */
+  charset: null,
+
+  /**
    * Called when the request has been completed, including failures and
    * timeouts.
    *
@@ -310,6 +318,10 @@
     // will always be 'PUT'. Yeah, I know.
     channel.requestMethod = method;
 
+    // Before opening the channel, set the charset that serves as a hint
+    // as to what the response might be encoded as.
+    channel.contentCharset = this.charset ? this.charset : "utf-8";
+
     // Blast off!
     channel.asyncOpen(this, null);
     this.status = this.SENT;
@@ -369,18 +381,8 @@
     response.request = this;
     response.body = "";
 
-    // Define this here so that we don't have make a new one each time
-    // onDataAvailable() gets called. If the Content-Type specified a charset,
-    // make sure we use the correct converter stream, instead of a generic
-    // ScriptableInputStream (onDataAvailable will pick the right one).
-    if (channel.contentCharset) {
-      response.charset = channel.contentCharset;
-      this._converterStream = Cc["@mozilla.org/intl/converter-input-stream;1"]
-                                .createInstance(Ci.nsIConverterInputStream);
-    } else {
-      this._inputStream = Cc["@mozilla.org/scriptableinputstream;1"]
-                          .createInstance(Ci.nsIScriptableInputStream);
-    }
+    this._converterStream = Cc["@mozilla.org/intl/converter-input-stream;1"]
+                            .createInstance(Ci.nsIConverterInputStream);
     this.delayTimeout();
   },
 
@@ -442,20 +444,17 @@
   },
 
   onDataAvailable: function onDataAvailable(req, cb, stream, off, count) {
+    // response.charset should always be set to a value, since we provided a
+    // hint at dispatch.
     try {
-      if (this._inputStream) {
-        this._inputStream.init(stream);
-        this.response.body += this._inputStream.read(count);
-      } else {
-        let str = {};
-        this._converterStream.init(
-          stream, this.response.charset, 0,
-          this._converterStream.DEFAULT_REPLACEMENT_CHARACTER
-        );
-        let num = this._converterStream.readString(count, str);
-        if (num != 0) {
-          this.response.body += str.value;
-        }
+      let str = {};
+      this._converterStream.init(
+        stream, this.response.charset, 0,
+        this._converterStream.DEFAULT_REPLACEMENT_CHARACTER
+      );
+      let num = this._converterStream.readString(count, str);
+      if (num != 0) {
+        this.response.body += str.value;
       }
     } catch (ex) {
       this._log.warn("Exception thrown reading " + count +
diff --git a/services/common/tests/unit/test_restrequest.js b/services/common/tests/unit/test_restrequest.js
--- a/services/common/tests/unit/test_restrequest.js
+++ b/services/common/tests/unit/test_restrequest.js
@@ -164,11 +164,13 @@
  */
 add_test(function test_get_utf8() {
   let response = "Hello World or Καλημέρα κόσμε or こんにちは 世界";
-  let contentType = "text/plain; charset=UTF-8";
+  let contentType = "text/plain";
+  let charset = true;
+  let charsetSuffix = "; charset=UTF-8";
 
   let server = httpd_setup({"/resource": function(req, res) {
     res.setStatusLine(req.httpVersion, 200, "OK");
-    res.setHeader("Content-Type", contentType);
+    res.setHeader("Content-Type", contentType + (charset ? charsetSuffix : ""));
 
     let converter = Cc["@mozilla.org/intl/converter-output-stream;1"]
                     .createInstance(Ci.nsIConverterOutputStream);
@@ -177,15 +179,30 @@
     converter.close();
   }});
 
-  let request = new RESTRequest(TEST_RESOURCE_URL);
-  request.get(function(error) {
-    do_check_eq(error, null);
+  // Check if charset in Content-Type is propertly interpreted.
+  let request1 = new RESTRequest(TEST_RESOURCE_URL);
+  request1.get(function(error) {
+    do_check_null(error);
 
-    do_check_eq(request.response.status, 200);
-    do_check_eq(request.response.body, response);
-    do_check_eq(request.response.headers["content-type"], contentType);
+    do_check_eq(request1.response.status, 200);
+    do_check_eq(request1.response.body, response);
+    do_check_eq(request1.response.headers["content-type"],
+                contentType + charsetSuffix);
 
-    server.stop(run_next_test);
+    // Check if specifying a charset hint also works if Content-Type doesn't
+    // provide one.
+    charset = false;
+    let request2 = new RESTRequest(TEST_RESOURCE_URL);
+    request2.charset = "utf-8";
+    request2.get(function(error) {
+      do_check_null(error);
+
+      do_check_eq(request2.response.status, 200);
+      do_check_eq(request2.response.body, response);
+      do_check_eq(request2.response.headers["content-type"], contentType);
+
+      server.stop(run_next_test);
+    });
   });
 });
 
